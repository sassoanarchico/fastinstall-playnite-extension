<UserControl x:Class="FastInstall.FastInstallSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="950">

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- TabControl for multiple settings pages -->
        <TabControl Grid.Row="0">
            
            <!-- TAB 1: Local Sources -->
            <TabItem Header="ðŸ“ Local Sources">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="15">
                    <StackPanel>
                        <!-- Header -->
                        <TextBlock Text="Local Folder Configurations" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Margin="0,0,0,10"/>

                        <!-- Description -->
                        <TextBlock Text="Configure source and destination folder pairs. Games will be scanned from source folders and can be installed to destination folders."
                                   TextWrapping="Wrap" 
                                   Margin="0,0,0,15"
                                   Opacity="0.8"/>

                        <!-- DataGrid for Local Sources -->
                        <DataGrid ItemsSource="{Binding EditingConfigurations}"
                                  SelectedItem="{Binding SelectedConfiguration, Mode=TwoWay}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  SelectionMode="Single"
                                  HeadersVisibility="All"
                                  GridLinesVisibility="All"
                                  AlternatingRowBackground="#10000000"
                                  MinHeight="150"
                                  MaxHeight="250"
                                  Margin="0,0,0,10">

                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="âœ“" 
                                                        Width="40"
                                                        Binding="{Binding IsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                                <DataGridTemplateColumn Header="Source Path (Archive HDD)" Width="2*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <DockPanel>
                                                <Button Content="..." 
                                                        DockPanel.Dock="Right" 
                                                        Width="30" 
                                                        Margin="5,0,0,0"
                                                        Command="{Binding DataContext.BrowseSourceCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                        CommandParameter="{Binding}"/>
                                                <TextBox Text="{Binding SourcePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         VerticalContentAlignment="Center"
                                                         Padding="5,2"/>
                                            </DockPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Destination Path (Fast SSD)" Width="2*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <DockPanel>
                                                <Button Content="..." 
                                                        DockPanel.Dock="Right" 
                                                        Width="30" 
                                                        Margin="5,0,0,0"
                                                        Command="{Binding DataContext.BrowseDestinationCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                        CommandParameter="{Binding}"/>
                                                <TextBox Text="{Binding DestinationPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         VerticalContentAlignment="Center"
                                                         Padding="5,2"/>
                                            </DockPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Platform" Width="130">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.AvailablePlatforms, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      SelectedItem="{Binding Platform, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      VerticalContentAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Emulator" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.AvailableEmulators, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      DisplayMemberPath="DisplayName"
                                                      SelectedValuePath="EmulatorId"
                                                      SelectedValue="{Binding EmulatorId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      VerticalContentAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Profile" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding AvailableProfilesForEmulator}"
                                                      DisplayMemberPath="DisplayName"
                                                      SelectedValuePath="ProfileId"
                                                      SelectedValue="{Binding EmulatorProfileId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      VerticalContentAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Buttons -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                            <Button Content="âž• Add Configuration" 
                                    Padding="15,8" 
                                    Margin="0,0,10,0"
                                    Command="{Binding AddConfigurationCommand}"/>
                            <Button Content="ðŸ—‘ Remove Selected" 
                                    Padding="15,8"
                                    Command="{Binding RemoveConfigurationCommand}"/>
                        </StackPanel>

                        <!-- General Settings -->
                        <Border Background="#15000000" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="General Settings" FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <CheckBox x:Name="EnableParallelCheckBox"
                                              Content="Enable Parallel Downloads"
                                              IsChecked="{Binding Settings.EnableParallelDownloads, Mode=TwoWay}"
                                              VerticalContentAlignment="Center"
                                              Margin="0,0,15,0"
                                              Checked="EnableParallelCheckBox_Checked"
                                              Unchecked="EnableParallelCheckBox_Unchecked"/>
                                    <TextBlock Text="Max Parallel: " VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <TextBox x:Name="MaxParallelTextBox"
                                             Text="{Binding Settings.MaxParallelDownloads, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             Width="50" Height="22"
                                             VerticalContentAlignment="Center"
                                             TextAlignment="Center"
                                             IsEnabled="{Binding ElementName=EnableParallelCheckBox, Path=IsChecked}"
                                             PreviewTextInput="MaxParallelTextBox_PreviewTextInput"
                                             LostFocus="MaxParallelTextBox_LostFocus"/>
                                    <TextBlock Text="(1-10)" Opacity="0.7" Margin="5,0,0,0" VerticalAlignment="Center" FontSize="11"/>
                                </StackPanel>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="Conflict Resolution: " VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <ComboBox x:Name="ConflictResolutionComboBox"
                                              SelectedItem="{Binding Settings.ConflictResolution, Mode=TwoWay}"
                                              Width="200" VerticalContentAlignment="Center"/>
                                </StackPanel>
                                
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="7-Zip Path: " VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox Text="{Binding Settings.SevenZipPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             Width="280" Height="22"
                                             VerticalContentAlignment="Center" Margin="0,0,10,0"/>
                                    <Button Content="Browse..." Width="80" Height="22" Click="BrowseSevenZipButton_Click" Margin="0,0,10,0"/>
                                    <Button Content="Download 7-Zip" Width="100" Height="22" Click="DownloadSevenZipButton_Click"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Info Box -->
                        <Border Background="#20808080" CornerRadius="5" Padding="15">
                            <StackPanel>
                                <TextBlock Text="Supported Platforms:" FontWeight="Bold" Margin="0,0,0,5"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.9">
                                    PC â€¢ PlayStation 3 (RPCS3) â€¢ PlayStation 2 (PCSX2) â€¢ PSP (PPSSPP) â€¢ Nintendo Switch (Ryujinx/Yuzu) â€¢ Wii U (Cemu) â€¢ Wii/GameCube (Dolphin) â€¢ Nintendo DS (MelonDS/DeSmuME) â€¢ Xbox 360 (Xenia)
                                </TextBlock>
                                
                                <TextBlock Text="Configure Emulators:" FontWeight="Bold" Margin="0,10,0,5"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.9">
                                    Go to Playnite â†’ Settings â†’ Emulation to add or configure emulators.
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 2: Cloud Sources (Google Drive) -->
            <TabItem Header="â˜ï¸ Google Drive">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="15">
                    <StackPanel>
                        <!-- Header -->
                        <TextBlock Text="Google Drive Integration" 
                                   FontSize="18" 
                                   FontWeight="Bold"
                                   Margin="0,0,0,10"/>

                        <!-- Description -->
                        <TextBlock Text="Download games directly from Google Drive. You can add links to individual files or shared folders."
                                   TextWrapping="Wrap" 
                                   Margin="0,0,0,15"
                                   Opacity="0.8"/>

                        <!-- API Key Section -->
                        <Border Background="#15000000" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="ðŸ”‘ API Key Configuration" FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>
                                
                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,10" Opacity="0.9">
                                    An API Key is optional for direct file links, but required for listing contents of shared folders.
                                </TextBlock>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="Google Drive API Key: " VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox x:Name="GoogleApiKeyTextBox"
                                             Text="{Binding Settings.GoogleDriveApiKey, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             Width="400" Height="22"
                                             VerticalContentAlignment="Center"/>
                                </StackPanel>

                                <Button Content="ðŸ“– How to get an API Key" 
                                        HorizontalAlignment="Left"
                                        Padding="10,5"
                                        Click="ShowApiKeyHelpButton_Click"/>
                            </StackPanel>
                        </Border>

                        <!-- Cloud Sources DataGrid -->
                        <TextBlock Text="Cloud Sources" FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>
                        
                        <DataGrid ItemsSource="{Binding EditingCloudSources}"
                                  SelectedItem="{Binding SelectedCloudSource, Mode=TwoWay}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  SelectionMode="Single"
                                  HeadersVisibility="All"
                                  GridLinesVisibility="All"
                                  AlternatingRowBackground="#10000000"
                                  MinHeight="150"
                                  MaxHeight="250"
                                  Margin="0,0,0,10">

                            <DataGrid.Columns>
                                <DataGridCheckBoxColumn Header="âœ“" 
                                                        Width="40"
                                                        Binding="{Binding IsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                                <DataGridTextColumn Header="Name" 
                                                    Width="150"
                                                    Binding="{Binding DisplayName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                                <DataGridTemplateColumn Header="Google Drive Link" Width="2*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <DockPanel>
                                                <Button Content="Test" 
                                                        DockPanel.Dock="Right" 
                                                        Width="50" 
                                                        Margin="5,0,0,0"
                                                        Command="{Binding DataContext.TestCloudConnectionCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                        CommandParameter="{Binding}"/>
                                                <TextBox Text="{Binding CloudLink, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         VerticalContentAlignment="Center"
                                                         Padding="5,2"/>
                                            </DockPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Destination Path" Width="*">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <DockPanel>
                                                <Button Content="..." 
                                                        DockPanel.Dock="Right" 
                                                        Width="30" 
                                                        Margin="5,0,0,0"
                                                        Command="{Binding DataContext.BrowseCloudDestinationCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                        CommandParameter="{Binding}"/>
                                                <TextBox Text="{Binding DestinationPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         VerticalContentAlignment="Center"
                                                         Padding="5,2"/>
                                            </DockPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Platform" Width="120">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.AvailablePlatforms, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      SelectedItem="{Binding Platform, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      VerticalContentAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Buttons -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                            <Button Content="âž• Add Cloud Source" 
                                    Padding="15,8" 
                                    Margin="0,0,10,0"
                                    Command="{Binding AddCloudSourceCommand}"/>
                            <Button Content="ðŸ—‘ Remove Selected" 
                                    Padding="15,8"
                                    Command="{Binding RemoveCloudSourceCommand}"/>
                        </StackPanel>

                        <!-- Help Box -->
                        <Border Background="#20808080" CornerRadius="5" Padding="15">
                            <StackPanel>
                                <TextBlock Text="ðŸ“š How Google Drive Integration Works" FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>
                                
                                <TextBlock Text="Link Types:" FontWeight="Bold" Margin="0,0,0,5"/>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,5">
                                    â€¢ Direct File Links: Links to a single file (game or archive). No API key needed.
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,10">
                                    â€¢ Shared Folder Links: Links to a folder containing multiple games. Requires API key to list contents.
                                </TextBlock>

                                <TextBlock Text="Supported Link Formats:" FontWeight="Bold" Margin="0,0,0,5"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.8" FontFamily="Consolas" Margin="0,0,0,5">
                                    https://drive.google.com/file/d/FILE_ID/view
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.8" FontFamily="Consolas" Margin="0,0,0,5">
                                    https://drive.google.com/drive/folders/FOLDER_ID
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="11" Opacity="0.8" FontFamily="Consolas" Margin="0,0,0,10">
                                    https://drive.google.com/open?id=FILE_ID
                                </TextBlock>

                                <TextBlock Text="Archive Support:" FontWeight="Bold" Margin="0,0,0,5"/>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9">
                                    ZIP, RAR, and 7Z archives are automatically extracted after download. Make sure 7-Zip is configured in the Local Sources tab.
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- TAB 3: About -->
            <TabItem Header="â„¹ï¸ About">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="15">
                    <StackPanel>
                        <TextBlock Text="FastInstall" 
                                   FontSize="24" 
                                   FontWeight="Bold"
                                   Margin="0,0,0,5"/>
                        
                        <TextBlock Text="{Binding PluginVersionDisplay, StringFormat=Version {0}}"
                                   FontSize="14"
                                   Foreground="LimeGreen"
                                   FontWeight="Bold"
                                   Margin="0,0,0,20"/>

                        <TextBlock Text="A Playnite extension to manage games stored on slow archival HDDs and install them by copying to fast SSDs."
                                   TextWrapping="Wrap" 
                                   Margin="0,0,0,20"
                                   Opacity="0.9"/>

                        <!-- Download Manager Button -->
                        <Button Content="ðŸ“¥ Open Download Manager" 
                                HorizontalAlignment="Left"
                                Padding="20,10"
                                Margin="0,0,0,20"
                                Click="OpenDownloadManagerButton_Click"
                                Background="#4CAF50"
                                Foreground="White"
                                FontWeight="Bold"
                                BorderThickness="0"/>

                        <Border Background="#20808080" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="Features" FontWeight="Bold" FontSize="14" Margin="0,0,0,10"/>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,3">â€¢ Multi-source configuration for different platforms</TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,3">â€¢ Background installation with progress tracking</TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,3">â€¢ Download queue with pause/resume support</TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,3">â€¢ Archive extraction (ZIP, RAR, 7Z)</TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,3">â€¢ Google Drive cloud download</TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9" Margin="0,0,0,3">â€¢ Emulator integration</TextBlock>
                                <TextBlock TextWrapping="Wrap" FontSize="12" Opacity="0.9">â€¢ Disk space verification</TextBlock>
                            </StackPanel>
                        </Border>

                        <Border Background="#20808080" CornerRadius="5" Padding="15">
                            <StackPanel>
                                <TextBlock Text="Author" FontWeight="Bold" FontSize="14" Margin="0,0,0,5"/>
                                <TextBlock Text="sassoanarchico" FontSize="12" Opacity="0.9"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
