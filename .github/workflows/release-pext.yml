name: Build and Release .pext

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Download Playnite SDK (for build)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Use GitHub's stable "latest/download" URL first (no API required).
          $zipPath = Join-Path $env:RUNNER_TEMP "PlayniteSDK.zip"
          $urls = @(
            "https://github.com/JosefNemec/Playnite/releases/latest/download/PlayniteSDK.zip",
            "https://github.com/JosefNemec/Playnite/releases/latest/download/PlaynitePortable.zip"
          )

          $downloaded = $false
          foreach ($u in $urls) {
            try {
              Write-Host "Trying: $u"
              Invoke-WebRequest -Uri $u -OutFile $zipPath -UseBasicParsing
              $downloaded = $true
              break
            } catch {
              Write-Host "Failed: $u"
            }
          }

          if (-not $downloaded) {
            throw "Failed to download Playnite SDK zip from latest release."
          }

          $extractDir = Join-Path $env:RUNNER_TEMP "playnite"
          if (Test-Path $extractDir) { Remove-Item $extractDir -Recurse -Force }
          Expand-Archive -Path $zipPath -DestinationPath $extractDir -Force

          $sdk = Get-ChildItem -Path $extractDir -Recurse -Filter "Playnite.SDK.dll" | Select-Object -First 1
          if (-not $sdk) { throw "Playnite.SDK.dll not found in extracted Playnite zip." }

          $destDir = Join-Path $env:LOCALAPPDATA "Playnite"
          New-Item -ItemType Directory -Force -Path $destDir | Out-Null
          Copy-Item -Force -Path $sdk.FullName -Destination (Join-Path $destDir "Playnite.SDK.dll")

      - name: Read version from extension.yaml
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $line = Select-String -Path "extension.yaml" -Pattern "^\s*Version\s*:" | Select-Object -First 1
          if (-not $line) { throw "Version not found in extension.yaml" }
          $version = ($line.Line -split ":", 2)[1].Trim()
          if (-not $version) { throw "Parsed version is empty" }

          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "TAG=v$version" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build (Release)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          msbuild "FastInstall.sln" /t:Rebuild /p:Configuration=Release /v:minimal

      - name: Create .pext package
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $releaseDir = Join-Path $PWD "bin\Release"
          if (-not (Test-Path $releaseDir)) { throw "Release output folder not found: $releaseDir" }

          $zipFile = Join-Path $PWD ("FastInstall_v{0}.zip" -f $env:VERSION)
          $pextFile = Join-Path $PWD ("FastInstall_v{0}.pext" -f $env:VERSION)

          if (Test-Path $zipFile) { Remove-Item $zipFile -Force }
          if (Test-Path $pextFile) { Remove-Item $pextFile -Force }

          Compress-Archive -Path (Join-Path $releaseDir "*") -DestinationPath $zipFile -Force
          Rename-Item -Path $zipFile -NewName ("FastInstall_v{0}.pext" -f $env:VERSION)

          if (-not (Test-Path $pextFile)) { throw ".pext was not created: $pextFile" }

      - name: Create/Update GitHub Release and upload asset (clobber)
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"

          $tag = $env:TAG
          $file = "FastInstall_v$($env:VERSION).pext"

          # Create release if missing, otherwise keep it and just overwrite the asset.
          gh release view $tag *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag --title "FastInstall $tag" --generate-notes
          }

          gh release upload $tag $file --clobber
